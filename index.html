<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>New Zealand Locations and Landscape Guesser</title>
  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#101a35;
      --glass: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --shadow: 0 14px 50px rgba(0,0,0,.45);
      --radius: 18px;

      --green: #2ecc71;
      --green2:#1fba60;
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(90,140,255,.18), transparent 60%),
        radial-gradient(900px 700px at 80% 30%, rgba(255,120,200,.12), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height: 100vh;
      padding: 18px 14px 40px;
    }

    .wrap{ max-width: 980px; margin: 0 auto; }

    header{ margin: 10px 0 14px; }
    h1{ font-size: 1.35rem; margin:0; letter-spacing: .2px; }
    .sub{ margin:.35rem 0 0; color: var(--muted); font-size:.95rem; line-height:1.35; }

    .panel{
      background: linear-gradient(180deg, var(--glass), rgba(255,255,255,.05));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      padding: 12px;
      align-items:flex-start;
      justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }

    .left{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .right{
      display:flex;
      flex-direction: column;
      align-items:flex-end;
      gap:10px;
      min-width: 240px;
    }
    .rightTop{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    button{
      appearance:none;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing:.2px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease, filter .2s ease;
      user-select:none;
    }
    button:hover{ background: rgba(255,255,255,.12); border-color: rgba(255,255,255,.22); }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.45; cursor:not-allowed; }

    .btn-reveal{
      background: linear-gradient(180deg, rgba(46,204,113,.95), rgba(31,186,96,.95));
      border-color: rgba(46,204,113,.65);
      color: rgba(255,255,255,.97);
      text-shadow: 0 1px 0 rgba(0,0,0,.25);
    }
    .btn-reveal:hover{ filter: brightness(1.05); border-color: rgba(46,204,113,.9); }
    .btn-reveal:disabled{
      background: rgba(46,204,113,.22);
      border-color: rgba(46,204,113,.22);
      color: rgba(255,255,255,.72);
      filter: none;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size: .88rem;
      white-space: nowrap;
    }
    .chip b{ color: var(--text); font-weight: 750; }

    select{
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding: 8px 10px;
      font-weight: 700;
      outline: none;
    }

    .stage{
      position: relative;
      height: min(70vh, 640px);
      background:
        radial-gradient(900px 450px at 50% 5%, rgba(255,255,255,.10), transparent 60%),
        rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .imgwrap{
      position: relative;
      width: 100%;
      height: 100%;
      padding: 14px;
    }

    img#photo{
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 16px;
      filter: drop-shadow(0 18px 40px rgba(0,0,0,.55));
      opacity: 0;
      transform: scale(.985);
      transition: opacity .35s ease, transform .35s ease;
      background: rgba(255,255,255,.03);
    }
    img#photo.loaded{
      opacity: 1;
      transform: scale(1);
    }

    .skeleton{
      position:absolute;
      inset: 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(90deg,
        rgba(255,255,255,.06),
        rgba(255,255,255,.12),
        rgba(255,255,255,.06));
      background-size: 240% 100%;
      animation: shimmer 1.2s infinite linear;
      opacity: 0;
      transition: opacity .2s ease;
      pointer-events:none;
    }
    .skeleton.on{ opacity: 1; }
    @keyframes shimmer{
      0%{ background-position: 100% 0; }
      100%{ background-position: -140% 0; }
    }

    .bottom{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      padding: 12px;
      align-items:start;
    }

    .card{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 14px;
    }

    .answerCard{
      border: 1px solid rgba(46,204,113,.25);
      background:
        radial-gradient(900px 250px at 20% 0%, rgba(46,204,113,.18), transparent 60%),
        radial-gradient(700px 220px at 80% 20%, rgba(46,204,113,.12), transparent 55%),
        rgba(255,255,255,.06);
    }
    .label{
      font-size: .78rem;
      text-transform: uppercase;
      letter-spacing:.14em;
      color: var(--muted);
    }
    .answerText{
      margin-top: 10px;
      font-size: clamp(1.5rem, 2vw, 3rem);
      font-weight: 700;
      line-height: 1.12;
      display:none;
    }
    .answerText.on{ display:block; }

    .answerHint{
      margin-top: 20px;
      color: var(--muted);
      font-size: .95rem;
      line-height: 1.35;
    }

    .credit{
      margin-top: 10px;
      color: var(--muted);
      font-size: .92rem;
      line-height: 1.35;
    }
    a{ color: rgba(170,215,255,.96); text-decoration: none; }
    a:hover{ text-decoration: underline; }

    .actionsRow{
      margin-top: 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    @keyframes pop {
      0% { transform: scale(1); }
      40% { transform: scale(1.015); }
      100% { transform: scale(1); }
    }
    .pop { animation: pop .18s ease-out; }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.14);
      padding: 10px 12px;
      border-radius: 999px;
      color: var(--text);
      font-weight: 700;
      opacity: 0;
      pointer-events:none;
      transition: opacity .25s ease, transform .25s ease;
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
    }
    .toast.on{
      opacity: 1;
      transform: translateX(-50%) translateY(-2px);
    }

    @media (max-width: 560px){
      .right{ min-width: unset; width: 100%; align-items:flex-start; }
      .rightTop{ justify-content:flex-start; }
    }

    button svg { flex: 0 0 auto; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>New Zealand Locations and Landscape Guesser</h1>
      <p class="sub">Tap <b>New Photo</b>, then <b>Reveal</b> to see where it is</p>
    </header>

    <div class="panel">
      <div class="toolbar">
        <div class="left">
          <button id="btnNew" title="New photo (N)">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M16 3h5v5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M21 3l-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M4 7h4l3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M4 17h4l3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M16 21h5v-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M21 21l-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            New Photo
          </button>

          <button id="btnReveal" class="btn-reveal" disabled title="Reveal (R)">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12Z" stroke="currentColor" stroke-width="2"/>
              <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="currentColor" stroke-width="2"/>
            </svg>
            Reveal
          </button>
        </div>

        <div class="right">
          <div class="rightTop">
            <span class="chip"><b>Mode</b></span>
            <select id="mode">
              <option value="art">High Quality</option>
              <option value="mix">Mixed</option>
            </select>
          </div>
        </div>
      </div>

      <div class="stage">
        <div class="imgwrap">
          <div class="skeleton" id="skeleton"></div>
          <img id="photo" alt="Random New Zealand photo" />
        </div>
      </div>

      <div class="bottom">
        <div class="card answerCard" id="answerCard">
          <div class="label">Answer</div>
          <div class="answerText" id="answer"></div>
          <div class="answerHint" id="answerHint">Hit <b>Reveal</b> to show the location name.</div>

          <div class="actionsRow">
            <button id="btnCopy" disabled title="Copy answer">Copy answer</button>
            <span class="chip" id="sourceChip" style="display:none; cursor:pointer;"></span>
          </div>
        </div>
        <span class="chip" id="statusChip">Status: Ready</span>
        <div class="card">
          <div class="label">Credits</div>
          <div class="credit" id="credit"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  // ============================
  // UNSPLASH ONLY (add your key)
  // ============================
  const UNSPLASH_ACCESS_KEY = "OsJIVxegKk4aFOOdQpCOd_NfKsaIm0AX6nZEddTn0Hc";
  const UTM_SOURCE = "nz_location_guesser";
  const UTM_MEDIUM = "referral";

  // --- Filtering: skip wildlife (best-effort on text/tags) ---
  const WILDLIFE_BLOCKLIST = [
    /birds?/i, /animals?/i, /wildlife/i, /fauna/i,
    /insects?/i, /fish/i, /mammals?/i, /reptiles?/i, /amphibians?/i
  ];

  // Keep your Mode UI exactly the same, but use it to pick search queries
  const QUERIES_ART = [
    "new zealand landscape",
    "new zealand mountains landscape",
    "new zealand lake landscape",
    "new zealand fjord landscape",
    "new zealand coastline landscape",
    "new zealand national park landscape",
    "new zealand sunrise landscape",
    "new zealand sunset landscape"
  ];

  const QUERIES_MIX = [
    "new zealand scenic",
    "new zealand beach landscape",
    "new zealand road landscape",
    "new zealand forest landscape",
    "new zealand waterfall landscape",
    "new zealand river landscape",
    "new zealand glacier landscape",
    "new zealand rugged coast landscape"
  ];

  // --- Prevent repeats (persisted) ---
  const SEEN_KEY = "nz_photo_guess_seen_v1";
  const MAX_SEEN = 2500;
  let seen = new Set(JSON.parse(localStorage.getItem(SEEN_KEY) || "[]"));

  function hasSeen(id){ return seen.has(id); }
  function markSeen(id){
    seen.add(id);
    if (seen.size > MAX_SEEN){
      const arr = Array.from(seen);
      seen = new Set(arr.slice(arr.length - Math.floor(MAX_SEEN * 0.8)));
    }
    localStorage.setItem(SEEN_KEY, JSON.stringify(Array.from(seen)));
  }

  // --- DOM ---
  const statusChip = document.getElementById("statusChip");
  const skeleton = document.getElementById("skeleton");
  const imgEl = document.getElementById("photo");
  const creditEl = document.getElementById("credit");
  const answerEl = document.getElementById("answer");
  const answerHintEl = document.getElementById("answerHint");
  const toastEl = document.getElementById("toast");
  const sourceChip = document.getElementById("sourceChip");
  const answerCard = document.getElementById("answerCard");

  const btnNew = document.getElementById("btnNew");
  const btnReveal = document.getElementById("btnReveal");
  const btnCopy = document.getElementById("btnCopy");
  const modeEl = document.getElementById("mode");

  let current = null;

  function setStatus(text){ statusChip.textContent = `Status: ${text}`; }
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("on");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>toastEl.classList.remove("on"), 1200);
  }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function setLoading(on){
    skeleton.classList.toggle("on", on);
    if (on){
      imgEl.classList.remove("loaded");
      imgEl.removeAttribute("src");
    }
  }

  function resetAnswerUI(){
    answerEl.classList.remove("on");
    answerEl.textContent = "";
    answerHintEl.innerHTML = `Hit <b>Reveal</b> to show the location name.`;
    btnCopy.disabled = true;
    sourceChip.style.display = "none";
    sourceChip.textContent = "";
  }

  function loadImage(url){
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => resolve(true);
      img.onerror = () => resolve(false);
      img.src = url;
    });
  }

  function isWildlifeText(s){
    const t = (s || "").toString();
    return WILDLIFE_BLOCKLIST.some(rx => rx.test(t));
  }

  function photoLooksWildlife(photo){
    const tagTitles = (photo?.tags || []).map(t => t?.title || "").join(" ");
    const blob = [
      photo?.alt_description || "",
      photo?.description || "",
      tagTitles
    ].join(" ");
    return isWildlifeText(blob);
  }

  function withUtm(url){
    try{
      const u = new URL(url);
      u.searchParams.set("utm_source", UTM_SOURCE);
      u.searchParams.set("utm_medium", UTM_MEDIUM);
      return u.toString();
    } catch {
      return url;
    }
  }

  async function fetchUnsplashRandom(query){
    const url = new URL("https://api.unsplash.com/photos/random");
    url.searchParams.set("client_id", UNSPLASH_ACCESS_KEY);
    url.searchParams.set("query", query);
    url.searchParams.set("orientation", "landscape");
    url.searchParams.set("content_filter", "high");

    const r = await fetch(url.toString());
    if (!r.ok) return null;
    return await r.json();
  }

  function buildCurrentFromUnsplash(photo){
    const imageUrl = photo?.urls?.regular || photo?.urls?.full || photo?.urls?.raw;
    const photoPageUrl = withUtm(photo?.links?.html || "https://unsplash.com");
    const artistName = photo?.user?.name || "Unknown";
    const artistUrl = withUtm(photo?.user?.links?.html || "https://unsplash.com");
    const license = "Unsplash";

    // Location is often missing on Unsplash; use best available fallback
    let placeName = (photo?.location?.name || "").trim();
    if (!placeName){
      placeName = "New Zealand";
    }

    return {
      id: photo?.id || imageUrl,
      imageUrl,
      filePageUrl: photoPageUrl,
      artist: artistName,
      artistUrl,
      license,
      placeName,
      download_location: photo?.links?.download_location || ""
    };
  }

  function updateCredits(d){
    // Keep your Credits card, but point to Unsplash + photographer (with UTM)
    creditEl.innerHTML =
      `Source: <a href="${d.filePageUrl}" target="_blank" rel="noreferrer">Unsplash</a><br/>` +
      `Artist: <a href="${d.artistUrl}" target="_blank" rel="noreferrer">${escapeHtml(d.artist)}</a> · License: ${escapeHtml(d.license)}`;
  }

  function triggerDownload(d){
    // Unsplash guideline: hit download_location when a photo is used
    if (!d?.download_location) return;
    const url = `${d.download_location}?client_id=${encodeURIComponent(UNSPLASH_ACCESS_KEY)}`;
    fetch(url).catch(()=>{});
  }

  async function newPhoto(){
    if (!UNSPLASH_ACCESS_KEY || UNSPLASH_ACCESS_KEY.includes("PASTE_YOUR")) {
      setStatus("Add your Unsplash API key in the code");
      return;
    }

    btnNew.disabled = true;
    btnReveal.disabled = true;
    setLoading(true);
    resetAnswerUI();
    current = null;
    setStatus("Finding next photo…");

    try{
      const queries = (modeEl.value === "art") ? QUERIES_ART : QUERIES_MIX;

      for (let attempt = 0; attempt < 40; attempt++){
        const q = pick(queries);
        const photo = await fetchUnsplashRandom(q);
        if (!photo) continue;

        // best-effort wildlife filter
        if (photoLooksWildlife(photo)) continue;

        const d = buildCurrentFromUnsplash(photo);
        if (!d.imageUrl) continue;

        if (hasSeen(d.id)) continue;

        // test load before committing
        const ok = await loadImage(d.imageUrl);
        if (!ok) continue;

        current = d;
        markSeen(d.id);

        // Trigger download tracking (non-blocking)
        triggerDownload(d);

        imgEl.onload = () => {
          imgEl.classList.add("loaded");
          setLoading(false);
        };
        imgEl.onerror = () => {
          setLoading(false);
          setStatus("Image failed to render");
        };

        imgEl.src = current.imageUrl;
        updateCredits(current);

        btnReveal.disabled = false;
        setStatus("Photo loaded");
        toast("New photo!");
        return;
      }

      setLoading(false);
      setStatus("No valid image found — try again");
    } catch(e){
      console.error(e);
      setLoading(false);
      setStatus("Error (network)");
    } finally{
      btnNew.disabled = false;
    }
  }

  function reveal(){
    if (!current) return;

    answerEl.textContent = current.placeName;
    answerEl.classList.add("on");
    answerHintEl.textContent = "Location name pulled from the photo metadata (when available).";

    answerCard.classList.remove("pop");
    void answerCard.offsetWidth;
    answerCard.classList.add("pop");

    btnCopy.disabled = false;
    sourceChip.style.display = "inline-flex";
    sourceChip.innerHTML = `<b>Open source:</b> Unsplash page`;
    sourceChip.onclick = () => window.open(current.filePageUrl, "_blank");

    toast("Revealed");
  }

  async function copyAnswer(){
    if (!current) return;
    try{
      await navigator.clipboard.writeText(current.placeName);
      toast("Copied");
    } catch {
      window.prompt("Copy this:", current.placeName);
    }
  }

  btnNew.addEventListener("click", newPhoto);
  btnReveal.addEventListener("click", reveal);
  btnCopy.addEventListener("click", copyAnswer);

  modeEl.addEventListener("change", ()=>{
    toast(modeEl.value === "art" ? "High Quality" : "Mixed");
    newPhoto();
  });

  window.addEventListener("keydown", (e)=>{
    if (e.key.toLowerCase() === "n") newPhoto();
    if (e.key.toLowerCase() === "r") reveal();
  });

  // boot
  updateCredits({ filePageUrl:"#", artist:"—", artistUrl:"#", license:"—" });
  newPhoto();
</script>
</body>
</html>